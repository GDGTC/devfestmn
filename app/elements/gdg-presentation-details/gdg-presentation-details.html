<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-dialog/paper-action-dialog.html">
<link rel="import" href="../../../bower_components/paper-input/paper-autogrow-textarea.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../../../bower_components/firebase-element/firebase-element.html">
<link rel="import" href="../gdg-comment/gdg-comment.html">

<polymer-element name="gdg-presentation-details" attributes="id presentationId">
  <template>
    <link rel="stylesheet" href="gdg-presentation-details.css">

    <firebase-element location="https://devfestmn.firebaseio.com/comments/{{presentationId}}"
                      data="{{comments}}"
                      id="fbComments"
                      keys="{{keys}}"
                      childEvents>
    </firebase-element>

    <!-- Details -->
    <div>
      <p>Transitions into fuller Presentation Details view</p>
    </div>


    <!-- Comments -->
    <div class="comment">
      <template repeat="keys in keys">
        <p>I'm a comment</p>
        <p>{{comments[key].user.username}}</p>
        <p>{{comments[key].text}}</p>
      </template>
    </div>

    <div class="add-comment">
      <button on-click="{{openCommentDialog}}">
        Add a Comment

        <paper-action-dialog id="commentDialog"
                             heading="Add a Comment"
                             transition="core-transition-buttom">

          <form>
            <paper-autogrow-textarea id="commentTextArea">
              <label for="commentText" hidden?="{{!commentError}}">{{commentError}}</label>
              <textarea id="commentText" placeholder="Begin your comment here"></textarea>
            </paper-autogrow-textarea>
          </form>

          <paper-button affirmative autofocus on-click="{{submitComment}}">Submit</paper-button>

        </paper-action-dialog>

      </button>
    </div>


  </template>
  <script>
    (function () {

      Polymer({

        openCommentDialog: function () {
          this.$.commentDialog.toggle();
        },

        submitComment: function () {

          if (!this.$.commentText.value.length) {
            this.commentError.value = 'Please enter some content before submitting';
            return;
          }

          this.$.fbComments.push({
            text: this.$.commentText.value,
            user: {
              uid: this.globals.currentUser.uid,
              username: this.globals.currentUser.username,  // TODO: Setup some globals
              avatarUrl: this.globals.currentUser.google.cachedUserProfile.avatarUrl,
              htmlUrl: this.globals.currentUser.google.cachedUserProfile.htmlUrl
            },
            timestamp: new Date().getTime()
          });

          this.$.commentText.value = '';

        }


      });
    })();
  </script>
</polymer-element>
