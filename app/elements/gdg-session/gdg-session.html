<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../../bower_components/core-signals/core-signals.html">

<link rel="import" href="../gdg-presentation-card/gdg-presentation-card.html">
<link rel="import" href="../gdg-presentation-details/gdg-presentation-details.html">
<link rel="import" href="../../../bower_components/firebase-element/firebase-element.html">

<polymer-element name="gdg-session" attributes="sessionId">

  <template>
    <link rel="stylesheet" href="gdg-session.css">

    <core-signals on-core-signal-view-mode="{{handleNewViewMode}}"></core-signals>

    <firebase-element location="https://devfestmn.firebaseio.com/presentations/{{sessionId}}"
                      keys="{{presentationKeys}}"
                      data="{{presentations}}"
                      id="fbPresentations">
    </firebase-element>

    <firebase-element location="https://devfestmn.firebaseio.com/tracks"
                      keys="{{trackKeys}}"
                      data="{{tracks}}"
                      id="fbTracks">
    </firebase-element>

    <section class="session-banner-container">
      <h1>I'm the banner area for session {{sessionId}}. Make me prettier!</h1>
    </section>


    <template repeat="{{key, indexNum in presentationKeys}}">


      <gdg-presentation-card favorited="{{presentations[key].favorited}}"
                             on-favorite-tapped="{{handleFavorited}}"
                             style="{{'background-color: ' +  tracks[presentations[key].track].primaryHexColor + ';'}}"
                             class="{{ {featured: presentations[key].featured, stretched: indexNum == 0 || indexNum == 1} | tokenList }}"
                             presentationId="{{key}}"
                             hidden?="{{viewMode === 'favorites' && !presentations[key].favorited}}">

        <section class="card-header">
          <img src="{{presentations[key].iconUrl}}" width="70" height="70">
        </section>


        <section class="card-body">
          <p>Speakers: <span>
                          {{presentations[key].speakers['1'] }}
                          <span hidden?="{{!presentations[key].speakers['2'] }}">
                            and {{presentations[key].speakers['2']}}
                          </span>
                       </span>
          </p>

          <div class="description" hidden?="{{!presentations[key].featured}}">
            <p>
              This is the description for this event, which is only visible here when the
              item gets set to "featured" and is moved up and given full width.
            </p>
          </div>
        </section>

        <section class="card-footer">
          <h2 style="{{'background-color: ' + tracks[presentations[key].track].accentHexColor + ';'}}">
            <span>{{presentations[key].subject}}</span>
          </h2>
        </section>

      </gdg-presentation-card>
    </template>


  </template>
  <script>
    (function () {
      Polymer({

        handleFavorited: function (event, detail, sender) {

          //  sender.templateInstance.model is a reference to the model data used to
          // construct a template instance. In this case, it would be
          // the 'presentation' object used to create a <gdg-presentation-card>
          var presentation = sender.templateInstance.model.presentation;
          console.log(presentation);
          //this.$.fbPresentations[presentation].favorited = true;  // TODO: Something like this to update the Firebase model
        },

        expandDetails: function (e) {
          var presentation = e.target.templateInstance.model.presentation;
          this.$.sessionItems.selected = presentation;
          console.log(presentation);
          console.log(this.$.sessionItems);

        },


        collapseDetails: function () {
          this.lastSelected = this.$.sessionItems.selected;
          console.log(this.lastSelected);
          this.$.sessionItems.selected = 0;
        },

        transitionEnd: function () {
          if (this.lastSelected) {
            this.lastSelected = null;
          }
        },

        /**
         * Receives a signal of the new view mode from core-signals
         */
        handleNewViewMode: function (e, detail /*sender*/) {
          this.viewMode = detail;
        },

        ready: function () {
          //var featuredPres = Math.floor(Math.random() * this.presentations.length);
        }

      });
    })();
  </script>
</polymer-element>
