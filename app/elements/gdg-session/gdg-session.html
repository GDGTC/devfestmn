<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../../bower_components/core-animated-pages/transitions/hero-transition.html">
<link rel="import" href="../../../bower_components/core-animated-pages/transitions/scale-up.html">
<link rel="import" href="../../../bower_components/core-animated-pages/transitions/list-cascade.html">
<link rel="import" href="../../../bower_components/core-icons/device-icons.html">


<link rel="import" href="../../../bower_components/core-signals/core-signals.html">

<link rel="import" href="../gdg-presentation-card/gdg-presentation-card.html">
<link rel="import" href="../gdg-presentation-details/gdg-presentation-details.html">
<link rel="import" href="../gdg-globals/gdg-globals.html">
<link rel="import" href="../../../bower_components/firebase-element/firebase-element.html">

<polymer-element name="gdg-session" attributes="sessionId sessionNum">

  <template>
    <link rel="stylesheet" href="gdg-session.css">

    <core-signals on-core-signal-view-mode="{{handleNewViewMode}}"></core-signals>
    <gdg-globals values="{{globals}}"></gdg-globals>


    <firebase-element location="https://devfestmn.firebaseio.com/presentations/{{sessionId}}"
                      keys="{{presentationKeys}}"
                      data="{{presentations}}"
                      id="fbPresentations">
    </firebase-element>

    <firebase-element location="https://devfestmn.firebaseio.com/tracks"
                      keys="{{trackKeys}}"
                      data="{{tracks}}"
                      id="fbTracks">
    </firebase-element>

    <firebase-element id="fbUser"
                      location="https://devfestmn.firebaseio.com/users/{{globals.user.uid}}"
                      data="{{loggedInUser}}">
    </firebase-element>

    <firebase-element location="https://devfestmn.firebaseio.com/sessions/{{sessionId}}"
                      id="fbSession"
                      data="{{gdgSession}}">
    </firebase-element>

    <!--
        <firebase-element location="https://devfestmn.firebaseio.com/comments/{{presentationId}}"
                          data="{{comments}}"
                          id="fbComments"
                          keys="{{commentKeys}}"
                          childEvents>
        </firebase-element>
    -->


    <!-- Begin content -->
    <section id="mainContainer">

      <section class="session-banner-container">
        <div layout horizontal>
          <h1 flex>Session {{sessionNum}}</h1>
            <span>
              <core-icon icon="device:access-time"></core-icon>
              {{gdgSession.startTime}} - {{gdgSession.endTime}}
            </span>
        </div>
      </section>

      <core-animated-pages id="cardPager" selected="{{selected}}" transitions="hero-transition"
                           on-core-animated-pages-transition-end="{{transitionComplete}}">

        <section hero>

          <div class="chip-container" hero-p on-tap="{{expandDetails}}">


            <template repeat="{{key, indexNum in presentationKeys}}">


              <gdg-presentation-card favorited="{{!!loggedInUser['favoritePresentations'][key]}}"
                                     hero-id="key"
                                     hero?="{{selectedPresId === key}}"
                                     on-favorite-tapped="{{handleFavorited}}"
                                     style="{{'background-color: ' +  tracks[presentations[key]['track']]['primaryBackgroundHex'] + ';' + ' color: rgba' + tracks[presentations[key]['track']]['primaryFontRGBA'] + ';'}}"
                                     class="chip {{ {featured: presentations[key].featured, stretched: indexNum == 0 || indexNum == 1} | tokenList }}"
                                     presentationId="{{key}}"
                                     sessionId="{{sessionId}}"
                                     hidden?="{{viewMode === 'favorites' && !loggedInUser['favoritePresentations'][key]}}">

                <section class="card-header">
                  <img src="{{presentations[key].iconUrl}}" width="70" height="70">

                </section>


                <section class="card-body" layout vertical>

                  <div class="speaker">

                        {{presentations[key].speakers['1']['name'] }}
                        <span hidden?="{{!presentations[key].speakers['2'] }}">
                          &amp; {{presentations[key].speakers['2']['name']}}
                        </span>
                  </div>
                  <hr/>

                  <div flex layout vertical center>
                    <p style="{{'color: rgba' + tracks[presentations[key]['track']]['primaryFontRGBA'] + ';'}}">
                      {{presentations[key].subject}}
                    </p>
                  </div>

                  <div class="short-desc" hidden?="{{!presentations[key].featured}}">
                    <p>
                      {{presentations[key].shortDescription}}
                    </p>
                  </div>
                </section>

                <section class="card-footer">
                  <h2
                    style="{{'background-color: ' + tracks[presentations[key]['track']]['accentBackgroundHex'] + ';' + 'color: rgba' + tracks[presentations[key]['track']]['accentColorRGBA'] + ';'}}">
                    <span>{{tracks[presentations[key]['track']]['title']}}</span>
                  </h2>
                </section>

              </gdg-presentation-card>

            </template>
          </div>

        </section>

        <section id="detailsContainer" hero>

          <gdg-presentation-details presentationId="{{selectedPresId}}"
                                    sessionId="{{sessionId}}"
                                    on-collapse-details="{{collapseDetails}}"
                                    hero-id="{{selectedPresId}}"
                                    hero
                                    on-core-animated-pages-transition-end="{{transitionComplete}}"
                                    style="{{'background-color: ' +  tracks[presentations[selectedPresId]['track']]['primaryBackgroundHex'] + ';'}}">

          </gdg-presentation-details>

        </section>

      </core-animated-pages>
    </section>


  </template>

  <script>
    (function () {
      Polymer({

        selected: 0,
        selectedPresId: null,

        handleFavorited: function (event, detail, sender) {

          //  sender.templateInstance.model is a reference to the model data used to
          // construct a template instance. In this case, it would be
          // the 'presentation' object used to create a <gdg-presentation-card>
          //this.$.fbPresentations[presentation].favorited = true;  // TODO: Something like this to update the Firebase model

          var presentationKey = sender.templateInstance.model.key;
          var presentation = this.presentations[presentationKey];

          var isNewFavorite = !this.loggedInUser.favoritePresentations[presentationKey];
          console.log(isNewFavorite);

          // Update the presentation's favorites count
          if ('favoriteCount' in presentation) {
            if (isNewFavorite) {
              presentation.favoriteCount += 1;
            } else {
              presentation.favoriteCount -= 1;
            }

          } else {
            // we should only here if we've never initialized to 1 before
            presentation.favoriteCount = 1;
          }
          this.$.fbPresentations.commitProperty(presentationKey);


          // Update the user's favorites
          if (this.loggedInUser) {

            if (isNewFavorite) {

              // Handle adding to favorites
              if ('favoritePresentations' in this.loggedInUser) {
                this.loggedInUser.favoritePresentations[presentationKey] = presentation;
              } else {
                this.loggedInUser.favoritePresentations = {
                  presentationKey: presentation
                };
              }

              // handle removing from favorites
            } else {
              delete this.loggedInUser.favoritePresentations[presentationKey];
            }
            this.$.fbUser.commitProperty('favoritePresentations');
          }
        },


        /**
         * Grab the presentationId to the card that was selected, then
         * flip this.selected to 1 to tell core-animated-pages
         * that element 1 (the gdg-card-details element below the
         * repeated cards) is now active
         */
        expandDetails: function (e) {
          var fbPresentation = e.target.templateInstance.model;
          this.selectedPresId = fbPresentation.key;
          this.selected = 1;
        },


        collapseDetails: function (/*event, detail, sender*/) {
          this.lastSelected = this.selectedPresId;
          this.selected = 0;
          this.selectedPresId = null;
        },

        transitionComplete: function () {
          if (this.selectedPresId && this.selected === 0) {
            //this.selectedPresId = null;
          }
        },

        /**
         * Receives a signal of the new view mode from core-signals
         */
        handleNewViewMode: function (e, detail /*sender*/) {
          this.viewMode = detail;
        },


        domReady: function () {
        }

      });
    })();
  </script>
</polymer-element>
