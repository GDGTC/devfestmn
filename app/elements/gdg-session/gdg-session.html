<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../../bower_components/core-animated-pages/transitions/hero-transition.html">
<link rel="import" href="../../../bower_components/core-animated-pages/transitions/scale-up.html">
<link rel="import" href="../../../bower_components/core-animated-pages/transitions/list-cascade.html">

<link rel="import" href="../../../bower_components/core-signals/core-signals.html">

<link rel="import" href="../gdg-presentation-card/gdg-presentation-card.html">
<link rel="import" href="../gdg-presentation-details/gdg-presentation-details.html">
<link rel="import" href="../gdg-globals/gdg-globals.html">
<link rel="import" href="../../../bower_components/firebase-element/firebase-element.html">

<polymer-element name="gdg-session" attributes="sessionId">

  <template>
    <link rel="stylesheet" href="gdg-session.css">

    <core-signals on-core-signal-view-mode="{{handleNewViewMode}}"></core-signals>
    <gdg-globals values="{{globals}}"></gdg-globals>


    <firebase-element location="https://devfestmn.firebaseio.com/presentations/{{sessionId}}"
                      keys="{{presentationKeys}}"
                      data="{{presentations}}"
                      id="fbPresentations">
    </firebase-element>

    <firebase-element location="https://devfestmn.firebaseio.com/tracks"
                      keys="{{trackKeys}}"
                      data="{{tracks}}"
                      id="fbTracks">
    </firebase-element>

    <firebase-element id="fbUser"
                      location="https://devfestmn.firebaseio.com/users/{{globals.user.uid}}"
                      data="{{loggedInUser}}">
    </firebase-element>




    <!-- Begin content -->
    <section id="mainContainer">
      <section class="session-banner-container">
        <h1>I'm the banner area for session {{sessionId}}. Make me prettier!</h1>
      </section>

      <core-animated-pages id="cardPager" selected="{{selected}}" transitions="hero-transition cross-fade scale-up">

        <section id="listContainer">
          <template repeat="{{key, indexNum in presentationKeys}}">


            <gdg-presentation-card favorited="{{!!loggedInUser['favoritePresentations'][key]}}"
                                   id="key"
                                   on-tap="{{expandDetails}}"
                                   on-favorite-tapped="{{handleFavorited}}"
                                   style="{{'background-color: ' +  tracks[presentations[key]['track']]['primaryBackgroundHex'] + ';'}}"
                                   class="{{ {featured: presentations[key].featured, stretched: indexNum == 0 || indexNum == 1} | tokenList }}"
                                   presentationId="{{key}}"
                                   sessionId="{{sessionId}}"
                                   hidden?="{{viewMode === 'favorites' && !loggedInUser['favoritePresentations'][key]}}">

              <section class="card-header">
                <img src="{{presentations[key].iconUrl}}" width="70" height="70">
              </section>


              <section class="card-body">
                <p>Speaker<span hidden?="{{!presentations[key].speakers['2']}}">s</span>:
                       <span>
                          {{presentations[key].speakers['1']['name'] }}
                          <span hidden?="{{!presentations[key].speakers['2'] }}">
                            &amp; {{presentations[key].speakers['2']['name']}}
                          </span>
                       </span>
                </p>

                <div class="description" hidden?="{{!presentations[key].featured}}">
                  <p>
                    This is the description for this event, which is only visible here when the
                    item gets set to "featured" and is moved up and given full width.
                  </p>
                </div>
              </section>

              <section class="card-footer">
                <h2 style="{{'background-color: ' + tracks[presentations[key]['track']]['accentBackgroundHex'] + ';' + 'color: rgba' + tracks[presentations[key]['track']]['fontRGBA'] + ';'}}">
                  <span>{{presentations[key].subject}}</span>
                </h2>
              </section>

            </gdg-presentation-card>

          </template>
        </section>

        <gdg-presentation-details presentationId="{{selectedPresId}}" sessionId="{{sessionId}}"></gdg-presentation-details>

      </core-animated-pages>
    </section>


  </template>

  <script>
    (function () {
      Polymer({

        handleFavorited: function (event, detail, sender) {

          //  sender.templateInstance.model is a reference to the model data used to
          // construct a template instance. In this case, it would be
          // the 'presentation' object used to create a <gdg-presentation-card>
          //this.$.fbPresentations[presentation].favorited = true;  // TODO: Something like this to update the Firebase model

          var presentationKey = sender.templateInstance.model.key;
          var presentation = this.presentations[presentationKey];

          var isNewFavorite = !this.loggedInUser.favoritePresentations[presentationKey];
          console.log(isNewFavorite);

          // Update the presentation's favorites count
          if (presentation.favoriteCount) {
            isNewFavorite ? presentation.favoriteCount++ : presentation.favoriteCount--;
          } else {
            // we should only here if we've never initialized to 1 before
            presentation.favoriteCount = 1;
          }
          this.$.fbPresentations.commitProperty(presentationKey);


          // Update the user's favorites
          if (this.loggedInUser) {

            if (isNewFavorite) {

              // Handle adding to favorites
              if (this.loggedInUser.favoritePresentations) {
                this.loggedInUser.favoritePresentations[presentationKey] = presentation;
              } else {
                this.loggedInUser.favoritePresentations = {
                  presentationKey: presentation
                };
              }

              // handle removing from favorites
            } else {
              delete this.loggedInUser.favoritePresentations[presentationKey];
            }
            this.$.fbUser.commitProperty('favoritePresentations');
          }
        },


        /**
         * Grab the presentationId to the card that was selected, then
         * flip this.selected to 1 to tell core-animated-pages
         * that element 1 (the gdg-card-details element below the
         * repeated cards) is now active
         */
        expandDetails: function (e) {
          var fbPresentation = e.target.templateInstance.model;
          this.$.selectedPresId = fbPresentation.key;
          this.selected = 1;
        },


        collapseDetails: function () {
          this.lastSelected = this.$.sessionItems.selected;
          console.log(this.lastSelected);
          this.$.sessionItems.selected = 0;
        },

        transitionEnd: function () {
          if (this.lastSelected) {
            this.lastSelected = null;
          }
        },

        /**
         * Receives a signal of the new view mode from core-signals
         */
        handleNewViewMode: function (e, detail /*sender*/) {
          this.viewMode = detail;
        },

        ready: function () {
          var cardPager = this.$.mainContainer.querySelector('#cardPager');
          cardPager.selected = 0;
        },

        domReady: function () {
          console.log(this.loggedInUser);
        }

      });
    })();
  </script>
</polymer-element>
